{% extends "layout.html" %}

{% block title %}
    Dashboard
{% endblock %}

{% block main %}
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Top Stories</h4>

            <!-- Filter dropdown styled like a select -->
            <form method="get" action="/" class="d-inline-block">
                <select name="tab" class="form-select form-select-sm rounded-pill py-2 ps-3" onchange="this.form.submit()">
                    <option value="all" {% if current_tab == "all" %}selected{% endif %}>All</option>
                    <option value="new" {% if current_tab == "new" %}selected{% endif %}>New</option>
                    <option value="old" {% if current_tab == "old" %}selected{% endif %}>Old</option>
                </select>
            </form>
        </div>
        <hr>
        
        <!-- https://getbootstrap.com/docs/4.0/components/list-group/ -->
        {% if articles %}
        <ul class="list-group list-group-flush">
            {% for a in articles %}
            <li class="list-group-item">
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <!-- Left side: link + title -->
                    <div class="d-flex align-items-center flex-grow-1">
                        <!-- Link to article -->
                        <a href="{{ a.article_url }}" title="Open article" class="me-2">
                            <i class="bi bi-link-45deg text-secondary fs-5"></i>
                        </a>
                        <!-- Title -->
                        <h5 class="mb-0 text-truncate">{{ a.title }}</h5>
                    </div>
                    
                    <!-- Right side: icons -->
                    <div class="d-flex align-items-center gap-2 ms-3">
                        <!-- Summary toggle -->
                        <button class="btn btn-sm btn-link p-0 summary-toggle"
                                data-url="{{ a.article_url }}"
                                data-id = "{{ a.id }}"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#summary-{{ loop.index }}"
                                aria-expanded="false"
                                aria-controls="summary-{{ loop.index }}"
                                title="Generate summary">
                            <i class="bi bi-plus-circle text-secondary fs-5"></i>
                        </button>

                        <!-- Expiry info -->
                        <div title="Expires in {{ a.expiry }} days">
                            <i class="bi bi-exclamation-circle text-warning fs-5"></i>
                        </div>

                        <!-- Delete article -->
                        <a href="/delete-article/{{ a.id }}" title="Delete article">
                            <i class="bi bi-x-circle text-danger fs-5"></i>
                        </a>
                    </div>
                </div>

                <!-- Collapsible content -->
                <div class="collapse my-2" id="summary-{{ loop.index }}">
                    <!-- Article info -->
                    <div class="text-start text-muted small">
                        <p class="mb-1">Source: {{ a.source }}</p>
                        <p class="mb-1">Published at: {{ a.pub_date }}</p>
                    </div>

                    <!-- Summary -->
                    <ul class="ms-4 mt-2 text-start summary-body mb-0">
                        {% if a.summary %}
                            {% for line in a.summary.splitlines() if line.strip().startswith(('-', '*', '+')) %}
                                <li>{{ line.strip().lstrip('-*+ ') }}</li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </li>  
            {% endfor %} 
        </ul>
        {% else %}
        <!-- Feedback prompt -->
        <p class="mt-4 text-muted">No articles available.</p>
        {% endif %}
    </div>   

    <!-- Loading overlay (hidden by default) -->
    <div id="loading-overlay" class="d-none position-fixed top-0 start-0 w-100 h-100 
        bg-dark bg-opacity-75 text-white 
        d-flex flex-column justify-content-center align-items-center z-index-1">
        <!-- Spinning thing -->
        <div class="spinner-border text-light m-3" role="status"></div>
        <!-- Text feedback -->
        <h4>Summarizing article...</h4>
        <p id="summary-progress">Preparing...</p>
        <p>Please do not close the browser tab.</p>
    </div>


    <script type="module">

        document.querySelectorAll('.summary-toggle').forEach(btn => {
            // Detect button clicks
            btn.addEventListener('click', async (e) => {

                // Get article id, url and summary container
                const url = btn.dataset.url;
                const articleId = btn.dataset.id
                const collapseDiv = document.querySelector(btn.getAttribute('data-bs-target'));
                const summaryList = collapseDiv.querySelector('.summary-body');

                if (summaryList.children.length > 0) return; // already summarized

                // Get overlay container and feedback text
                const overlay = document.getElementById("loading-overlay");
                const progressText = document.getElementById('summary-progress');
                const summarizer = null;

                try {
                    overlay.classList.remove("d-none");
                    progressText.textContent = "Checking summarizer availability...";

                    // Ensure API is supported
                    if (!('Summarizer' in self)) {
                        progressText.textContent = 'Summarizer API not available in this browser.';
                        return;
                    }
                    
                    // Congifure summarizer
                    const options = {
                        sharedContext: 'This is most probably a tech article.',
                        type: 'key-points',
                        format: 'markdown',
                        length: 'medium'
                    };

                    // Ensure summarizer API is usable
                    const availability = await Summarizer.availability(options);
                    if (availability === 'unavailable') {
                        progressText.textContent = 'Summarizer not supported on this device.';
                        return;
                    }
                    else if (availability === 'downloadable' || availability === 'downloading')
                    {
                        progressText.textContent = 'Downloading model...';
                    }

                    // Create summarizer
                    progressText.textContent = 'Preparing summarizer...';
                    summarizer = await Summarizer.create(options);

                    // Fetch article from flask
                    progressText.textContent = 'Fetching article text...';
                    const resp = await fetch(`/extract-article?url=${encodeURIComponent(url)}`);

                    if (!resp.ok) throw new Error("Failed to fetch article text.");  // Turn to catch
                    const text = await resp.text();                                  // Fetched
                    
                    // Variables for chunking for summary
                    let currentChunk = '';
                    let summaries = [];
                    const sentences = text.split(/(?<=[.!?])\s+/);   // Safer split: handles . or ! or ?
                    const maxQuota = summarizer.inputQuota || 5000;  // In case quota is undefined
                    let usage = 0;

                    // Summarize in chunks
                    progressText.textContent = 'Summarizing article in chunks...';

                    for (const sentence of sentences) {
                        // Get potential usage of an extra sentence
                        const potential = currentChunk + sentence + '.';              
                        const estimateUsage = await summarizer.measureInputUsage(potential);
                        
                        // If adding sentence exceeds quota
                        if (usage + estimateUsage > maxQuota && currentChunk.trim().length > 0) {
                            // Summarize current chunk if any (without current sentence)
                            const chunkSummary = await summarizer.summarize(currentChunk, {
                                context: 'Provide a clear, concise summary suitable for a tech audience of all ages and experience levels.',
                            });

                            // Keep track of chunk summaries
                            summaries.push(chunkSummary);
                            usage = 0;                      // Reset usage
                            currentChunk = sentence + '.';  // Reset chunk to current sentence
                        } 
                        else {
                            currentChunk = potential;  // Add sentence to chunk
                            usage += estimateUsage;    // Update usage
                        }
                    }

                    // Summarize last chunk (if last sentence within quota)
                    if (currentChunk.trim().length > 0) {
                        const chunkSummary = await summarizer.summarize(currentChunk, {
                            context: 'Provide a clear, concise summary suitable for a tech audience of all ages and experience levels.',
                        });
                        summaries.push(chunkSummary);  // Keep track of chunk summaries
                    }

                    // Combined summary
                    const combined = summaries.join('\n');  // Combine keypoints
                    const finalSummary = await summarizer.summarize(combined, {
                        context: 'Provide a clear, concise summary suitable for a tech audience of all ages and experience levels.',
                    });
                    
                    // Split each point to a list, trim, only get lines starting with bullet md syntax
                    const lines = finalSummary
                        .split('\n')                             
                        .filter(line =>                           
                            line.trim().startsWith('-') ||        
                            line.trim().startsWith('*') ||       
                            line.trim().startsWith('+')           
                        );
                    // Update the summary list without reload
                    summaryList.innerHTML = lines.map(line => `<li>${line.trim().replace(/^[-*+]\s*/, '')}</li>`).join('');

                    // Update summary in table via flask
                    await fetch('/update-summary', {
                        "method": "POST",
                        "headers": {"Content-Type": "application/json"},
                        "body": JSON.stringify({
                            "article_id": articleId,
                            "summary": finalSummary
                        })
                    })

                    const data = await resp.json();                      // Parse flask response
                    console.log("Summary updated successfully!", data);  // Notify success

                }
                catch (e) {
                    summaryList.innerHTML = `<p class="text-danger">Failed to summarize article: ${e}</p>`;
                }
                finally {
                    overlay.classList.add("d-none");  // Hide loading overlay
                }
            });
        });
        
    </script>
{% endblock %}