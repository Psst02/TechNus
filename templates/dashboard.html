{% extends "layout.html" %}

{% block title %}
    Dashboard
{% endblock %}

{% block main %}
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Top Stories</h4>

            <!-- Filter dropdown styled like a select -->
            <form method="get" action="/" class="d-inline-block">
                <select name="tab" class="form-select form-select-sm rounded-pill py-2 ps-3" onchange="this.form.submit()">
                    <option value="all" {% if current_tab == "all" %}selected{% endif %}>All</option>
                    <option value="new" {% if current_tab == "new" %}selected{% endif %}>New</option>
                    <option value="old" {% if current_tab == "old" %}selected{% endif %}>Old</option>
                </select>
            </form>
        </div>
        <hr>
        
        <!-- https://getbootstrap.com/docs/4.0/components/list-group/ -->
        {% if articles %}
        <ul class="list-group list-group-flush">
            {% for a in articles %}
            <li class="list-group-item">
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <!-- Left side: link + title -->
                    <div class="d-flex align-items-center flex-grow-1">
                        <!-- Link to article -->
                        <a href="{{ a.article_url }}" title="Open article" class="me-2">
                            <i class="bi bi-link-45deg text-secondary fs-5"></i>
                        </a>
                        <!-- Title -->
                        <h5 class="mb-0 text-truncate">{{ a.title }}</h5>
                    </div>
                    
                    <!-- Right side: icons -->
                    <div class="d-flex align-items-center gap-2 ms-3">
                        <!-- Summary toggle -->
                        <button class="btn btn-sm btn-link p-0 summary-toggle"
                                data-url="{{ a.article_url }}"
                                data-id = "{{ a.id }}"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#summary-{{ loop.index }}"
                                aria-expanded="false"
                                aria-controls="summary-{{ loop.index }}"
                                title="Generate summary">
                            <i class="bi bi-plus-circle text-secondary fs-5"></i>
                        </button>

                        <!-- Expiry info -->
                        <div title="Expires in {{ a.expiry }} days">
                            <i class="bi bi-exclamation-circle text-warning fs-5"></i>
                        </div>

                        <!-- Delete article -->
                        <a href="/delete-article/{{ a.id }}" title="Delete article">
                            <i class="bi bi-x-circle text-danger fs-5"></i>
                        </a>
                    </div>
                </div>

                <!-- Collapsible content -->
                <div class="collapse my-2" id="summary-{{ loop.index }}">
                    <!-- Article info -->
                    <div class="text-start text-muted small">
                        <p class="mb-1">Source: {{ a.source }}</p>
                        <p class="mb-1">Published at: {{ a.pub_date }}</p>
                    </div>

                    <!-- Summary -->
                    <div class="ms-4 mt-2 text-start summary-body">
                        <p class="mb-0">{{ a.summary | default('') }}</p>
                    </div>
                </div>
            </li>  
            {% endfor %} 
        </ul>
        {% else %}
        <!-- Feedback prompt -->
        <p class="mt-4 text-muted">No articles available.</p>
        {% endif %}
    </div>   

    <!-- Loading overlay (hidden by default) -->
    <div id="loading-overlay" class="d-none position-fixed top-0 start-0 w-100 h-100 
        bg-dark bg-opacity-75 text-white 
        d-flex flex-column justify-content-center align-items-center z-index-1">
        <!-- Spinning thing -->
        <div class="spinner-border text-light m-3" role="status"></div>
        <!-- Text feedback -->
        <h4>Summarizing article...</h4>
        <p id="summary-progress">Preparing...</p>
        <p>Please do not close the browser tab.</p>
    </div>


    <script type="module">

        document.querySelectorAll('.summary-toggle').forEach(btn => {
            // Detect button clicks
            btn.addEventListener('click', async (e) => {

                // Get article id, url and summary container
                const url = btn.dataset.url;
                const articleId = btn.dataset.id
                const collapseDiv = document.querySelector(btn.getAttribute('data-bs-target'));
                const summaryDiv = collapseDiv.querySelector('.summary-body');

                // Avoid regenerating summary if it already exists
                const existingSummary = summaryDiv.textContent.trim();
                if (existingSummary !== '') return;

                // Get overlay container and feedback text
                const overlay = document.getElementById("loading-overlay");
                const progressText = document.getElementById('summary-progress');
                const summarizer = null;

                try {
                    overlay.classList.remove("d-none");
                    progressText.textContent = "Checking summarizer availability...";

                    // Ensure API is supported
                    if (!('Summarizer' in self)) {
                        progressText.textContent = 'Summarizer API not available in this browser.';
                        return;
                    }
                    
                    // Congifure summarizer
                    const options = {
                        sharedContext: '',
                        type: 'key-points',
                        format: 'plain-text',
                        length: 'medium'
                    };

                    // Ensure summarizer API is usable
                    const availability = await Summarizer.availability(options);
                    if (availability === 'unavailable') {
                        progressText.textContent = 'Summarizer not supported on this device.';
                        return;
                    }
                    else if (availability === 'downloadable' || availability === 'downloading')
                    {
                        progressText.textContent = 'Downloading model...';
                    }

                    // Create summarizer
                    progressText.textContent = 'Preparing summarizer...';
                    summarizer = await Summarizer.create(options);

                    // Fetch article from flask
                    progressText.textContent = 'Fetching article text...';
                    const resp = await fetch(`/extract-article?url=${encodeURIComponent(url)}`);

                    if (!resp.ok) throw new Error("Failed to fetch article text.");  // Turn to catch
                    const text = await resp.text();                                  // Fetched
                    
                    // Variables for chunking for summary
                    let chunk = '';
                    let chunkCount = 0;
                    let totalUsage = 0;
                    let summaries = [];
                    const maxQuota = summarizer.inputQuota;

                    // Summarize in chunks
                    progressText.textContent = 'Summarizing article in chunks...';
                    for (const sentence of text.split('.')) {
                        // Get potential usage of an extra sentence
                        const potentialChunk = chunk + sentence + '.';              
                        const usage = await summarizer.measureInputUsage(potentialChunk);
                        
                        // Consumed quota surpasses limit
                        if (totalUsage + usage > maxQuota) {
                            // Summarize current chunk if any (without current sentence)
                            if (chunkCount > 0) {
                                const chunkSummary = await summarizer.summarize(chunk, {
                                    context: 'Provide a clear, concise summary suitable for a tech audience of all ages and experience levels.',
                                });

                                // Keep track of chunk summaries
                                summaries.push(chunkSummary);
                                totalUsage = 0;
                            }
                            chunk = sentence + '.';  // Reset chunk to current sentence
                            chunkCount++;            // Start new chunk
                        } 
                        else {
                            chunk = potentialChunk;  // Add sentence to chunk
                            totalUsage += usage;     // Update usage
                        }
                    }

                    // Summarize last chunk (if last sentence within quota)
                    if (chunk) {
                        const chunkSummary = await summarizer.summarize(chunk, {
                            context: 'Provide a clear, concise summary suitable for a tech audience of all ages and experience levels.',
                        });
                        summaries.push(chunkSummary);  // Keep track of chunk summaries
                    }

                    // Combined summary
                    const combined = summaries.join(' ');  // Combine summaries into string
                    const finalSummary = await summarizer.summarize(combined, {
                        context: 'Provide a clear, concise summary suitable for a tech audience of all ages and experience levels.',
                    });
                    summaryDiv.innerHTML = `<p>${finalSummary}</p>`;  // Update summary

                    // Update summary in table via flask
                    fetch('/update-summary', {
                        "method": "POST",
                        "headers": {"Content-Type": "application/json"},
                        "body": JSON.stringify({
                            "article_id": articleId,
                            "summary": finalSummary
                        })
                    })
                    .then(response => response.json())                              // Parse flask response
                    .then(data => {console.log("Summary updated successfully!");})  // Notify if success
                    .catch(e => console.error("Failed to update summary:", e));     // Notify if error
                }
                catch (e) {
                    summaryDiv.innerHTML = `<p class="text-danger">Failed to summarize article: ${e}</p>`;
                }
                finally {
                    overlay.classList.add("d-none");  // Hide loading overlay
                }
            });
        });
        
    </script>
{% endblock %}